{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.6.18.56646",
      "templateHash": "8559397068988326613"
    }
  },
  "parameters": {
    "environmentUrl": {
      "type": "string",
      "defaultValue": "http://contoso-uat.sandbox.operations.dynamics.com/",
      "metadata": {
        "description": "(Required) URL of the Dynamics 365 environment (example: https://contoso-uat.sandbox.operations.dynamics.com/)"
      }
    },
    "existingIotHubResourceGroupName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Resource group name of the IoT Hub to reuse. Leave empty to create a new IoT Hub."
      }
    },
    "existingIotHubName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Resource name of the IoT Hub to reuse. Leave empty to create a new IoT Hub."
      }
    }
  },
  "variables": {
    "$fxv#0": "CREATE TABLE IotInput(\n  eventEnqueuedUtcTime datetime,\n  sensorId nvarchar(max)\n);\n\nCREATE TABLE SensorJobsReferenceInput(\n  sensorId nvarchar(max),\n  jobId nvarchar(max),\n  isJobInProgress nvarchar(max),\n  jobDataAreaId nvarchar(max),\n  machineNotReportingThreshold bigint\n);\n\n/* Query for machine reporting status scenario (equipment downtime) */\nWITH FakeHeartBeat AS /* Generate an event for every time window  */\n(\n  SELECT COUNT(*)\n  FROM IotInput\n  TIMESTAMP BY eventEnqueuedUtcTime\n  GROUP BY HoppingWindow(Duration(hour, 12), Hop(minute, 1))\n),\nAllSensors AS /* generate one event per sensor per period */\n(\n  SELECT\n    SensorJobsReferenceInput.SensorId AS machineId,\n    SensorJobsReferenceInput.IsJobInProgress AS isJobInProgress,\n    SensorJobsReferenceInput.JobId AS jobId,\n    SensorJobsReferenceInput.JobDataAreaId AS dataAreaId,\n    SensorJobsReferenceInput.MachineNotReportingThreshold AS thresholdMins,\n    System.Timestamp() AS timestamp\n  FROM FakeHeartBeat\n  JOIN SensorJobsReferenceInput\n  ON 1 = 1 /* Cross Join */\n),\nActiveSensors AS /* compute how many events have been received in the time window from each device */\n(\n  SELECT\n    sensorId AS machineId,\n    COUNT(*) AS eventCount,\n    System.Timestamp() AS timestamp\n  FROM IotInput\n  TIMESTAMP BY eventEnqueuedUtcTime\n  GROUP BY sensorId, TumblingWindow(minute, 1)\n),\nAllSensorEventCounts AS /* Find event count for every device, also those with zero events if they should be in progress */\n(\n  SELECT\n    AllSensors.*,\n    CASE WHEN ActiveSensors.eventCount IS NULL THEN 0\n      ELSE ActiveSensors.eventCount\n    END AS eventCount\n  FROM AllSensors LEFT JOIN ActiveSensors\n  ON\n    ActiveSensors.machineId = AllSensors.machineId\n    AND DATEDIFF(ms, ActiveSensors, AllSensors) = 0\n),\nSensorEventCountsWithinTwoThresholds AS /* Filter out all events earlier than two thresholds ago */\n(\n  SELECT *\n  FROM AllSensorEventCounts\n  WHERE DATEDIFF(minute, timestamp, System.Timestamp) < 2*thresholdMins\n  AND AllSensorEventCounts.jobId IS NOT NULL\n  AND AllSensorEventCounts.isJobInProgress = 'Yes'\n),\nLastSensorEvents AS /* Find the number of minutes since each device last recieved events */\n(\n  SELECT\n    *,\n    COALESCE(\n      DATEDIFF(\n        minute,\n        LAG(timestamp) OVER (PARTITION BY machineId LIMIT DURATION(hour, 12) WHEN eventCount > 0), /* Maximum lookback is 12 hours, data only goes two thresholds back */\n        timestamp\n      ),\n      2*thresholdmins\n    ) AS minutesSinceLastEvent\n  FROM SensorEventCountsWithinTwoThresholds\n),\nStartedAndStoppedSensors AS /* Find devices that stopped sending or started sending */\n(\n  (SELECT\n    *,\n    'TRUE' AS isMachineRunning\n  FROM LastSensorEvents\n  WHERE\n  (minutesSinceLastEvent >= thresholdMins AND eventCount > 0))\n  UNION\n  (SELECT\n    *,\n    'FALSE' AS isMachineRunning\n  FROM LastSensorEvents\n  WHERE\n    (minutesSinceLastEvent = thresholdMins AND eventCount = 0)\n  )\n)\n\nSELECT\n  machineId,\n  jobId,\n  dataAreaId,\n  isMachineRunning,\n  timestamp,\n  'MachineReportingStatus' AS notificationType\nINTO NotificationOutput\nFROM StartedAndStoppedSensors\n\nSELECT\n  CONCAT('MachineReportingStatus:', machineId) AS metricKey,\n  DATEDIFF(millisecond, CAST('1970-01-01' as datetime), timestamp) AS uts,\n  CAST(EventCount AS FLOAT) AS val\nINTO MetricOutput\nFROM AllSensorEventCounts\n",
    "$fxv#1": "CREATE TABLE IotInput(\n  eventEnqueuedUtcTime datetime,\n  sensorId nvarchar(max),\n  value float\n);\n\nCREATE TABLE ScenarioMappings(\n  sensorId nvarchar(max),\n  scenario nvarchar(max),\n  isSensorActiveForScenario nvarchar(max)\n);\n\nSELECT\n  I.sensorId,\n  System.Timestamp AS timestamp,\n  SUM(I.value) AS counterValue,\n  'AssetMaintenance' AS notificationType\nINTO NotificationOutput\nFROM IotInput I TIMESTAMP BY I.eventEnqueuedUtcTime\nJOIN ScenarioMappings SM ON SM.sensorId = I.sensorId\nWHERE\n  SM.scenario = 'AssetMaintenance'\n  AND SM.isSensorActiveForScenario = 'Yes'\nGROUP BY I.sensorId, TumblingWindow(hour, 3)\n",
    "$fxv#2": "CREATE TABLE IotInput(\n  eventEnqueuedUtcTime datetime,\n  sensorId nvarchar(max),\n  value float\n);\n\nCREATE TABLE SensorJobItemBatchAttributeReferenceInput(\n  sensorId nvarchar(max),\n  jobId nvarchar(max),\n  orderId nvarchar(max),\n  itemNumber nvarchar(max),\n  attributeName nvarchar(max),\n  jobDataAreaId nvarchar(max),\n  jobRegistrationStartDateTime datetime,\n  jobRegistrationStopDateTime datetime,\n  isJobCompleted nvarchar(max),\n  maximumAttributeTolerance float,\n  minimumAttributeTolerance float,\n  optimalAttributeValue float\n);\n\nWITH SensorJobItemBatchAttributeValues AS\n(\n  SELECT\n    I.sensorId,\n    I.eventEnqueuedUtcTime,\n    I.value,\n    R.jobId,\n    R.orderId,\n    R.itemNumber,\n    R.attributeName,\n    R.jobDataAreaId,\n    R.jobRegistrationStartDateTime,\n    R.jobRegistrationStopDateTime,\n    R.isJobCompleted,\n    R.maximumAttributeTolerance,\n    R.minimumAttributeTolerance,\n    R.optimalAttributeValue,\n    CASE\n      WHEN I.value >= R.minimumAttributeTolerance AND I.value <= R.maximumAttributeTolerance THEN 1\n      ELSE 0\n    END AS attributeValueInRange\n  FROM IotInput I\n  TIMESTAMP BY I.eventEnqueuedUtcTime\n  JOIN SensorJobItemBatchAttributeReferenceInput R\n  ON I.sensorId = R.sensorId\n  -- Only consider jobs which are in progress and signals which came after the start of the job.\n  WHERE DATEDIFF(year, R.jobRegistrationStopDateTime, CAST('1900-01-01' as datetime)) = 0\n  AND I.eventEnqueuedUtcTime >= R.jobRegistrationStartDateTime\n),\nSensorJobItemBatchAttributeValuesState AS\n(\n  SELECT\n  *,\n   /** Determine value for last signal was in range or not having same partition values as current signal.\n       previousSignalValueInRange will be null if there was no previous signal */\n  LAG(attributeValueInRange) OVER\n    (PARTITION BY\n      sensorId,\n      jobId,\n      orderId,\n      itemNumber,\n      attributeName,\n      jobDataAreaId\n      LIMIT DURATION(minute, 15)\n    ) AS previousSignalValueInRange\n    FROM SensorJobItemBatchAttributeValues\n)\n\nSELECT\n  CONCAT('ProductQuality:', jobId, ':', attributeName) AS metricKey,\n  DATEDIFF(millisecond, CAST('1970-01-01' as datetime), eventEnqueuedUtcTime) AS uts,\n  value AS val\nINTO MetricOutput\nfrom SensorJobItemBatchAttributeValues\n\nSELECT\n  jobDataAreaId AS dataAreaId,\n  sensorId AS machineId,\n  jobId AS jobId,\n  orderId AS orderId,\n  itemNumber AS itemId,\n  minimumAttributeTolerance AS minValue,\n  maximumAttributeTolerance AS maxValue,\n  optimalAttributeValue AS targetValue,\n  attributeName AS batchAttribId,\n  sensorId AS sensorId,\n  value AS sensorReading,\n  eventEnqueuedUtcTime AS timestamp,\n  eventEnqueuedUtcTime AS sensorTimestamp,\n  System.Timestamp AS processingTimestamp,\n  CASE\n    WHEN attributeValueInRange = 1 THEN 'TRUE'\n    ELSE 'FALSE'\n  END AS validAttributeSignal,\n  'ProductQualityValidation' AS notificationType\nINTO NotificationOutput\nFROM SensorJobItemBatchAttributeValuesState\n-- This ensures that we are not sending the notification twice.\nWHERE\n(\n  (\n    attributeValueInRange = 0 AND\n    (previousSignalValueInRange IS NULL OR previousSignalValueInRange = 1)\n  )\n  OR\n  (\n    attributeValueInRange = 1 AND\n    previousSignalValueInRange = 0\n  )\n)\n\n",
    "$fxv#3": "{\n  \"definition\": {\n    \"$schema\": \"https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#\",\n    \"actions\": {\n      \"AssetMaintenanceMappingsRefDataQuery\": {\n        \"inputs\": {\n          \"variables\": [\n            {\n              \"name\": \"AssetMaintenanceMappingsRefDataQuery\",\n              \"type\": \"string\",\n              \"value\": \"$filter=IsSensorActiveForScenario eq Microsoft.Dynamics.DataEntities.NoYes'Yes' and Scenario eq Microsoft.Dynamics.DataEntities.IoTIntCoreScenarioType'AssetMaintenance'\"\n            }\n          ]\n        },\n        \"runAfter\": {},\n        \"type\": \"InitializeVariable\"\n      },\n      \"CleanupAssetMaintenanceIfMoreThanOneBlob\": {\n        \"actions\": {\n          \"AssetMaintenanceDataCleanupLoop\": {\n            \"actions\": {\n              \"Delete_blob_(V2)_2\": {\n                \"inputs\": {\n                  \"headers\": {\n                    \"SkipDeleteIfFileNotFoundOnServer\": false\n                  },\n                  \"host\": {\n                    \"connection\": {\n                      \"name\": \"@parameters('$connections')['azureblob']['connectionId']\"\n                    }\n                  },\n                  \"method\": \"delete\",\n                  \"path\": \"/v2/datasets/@{encodeURIComponent(encodeURIComponent(parameters('StorageAccountName')))}/files/@{encodeURIComponent(encodeURIComponent(items('AssetMaintenanceDataCleanupLoop')?['Path']))}\"\n                },\n                \"runAfter\": {},\n                \"type\": \"ApiConnection\"\n              }\n            },\n            \"foreach\": \"@body('FilterAssetMaintanenceDataOlderThan7Days')\",\n            \"runAfter\": {\n              \"FilterAssetMaintanenceDataOlderThan7Days\": [\n                \"Succeeded\"\n              ]\n            },\n            \"type\": \"Foreach\"\n          },\n          \"FilterAssetMaintanenceDataOlderThan7Days\": {\n            \"inputs\": {\n              \"from\": \"@body('ListAllAssetMaintenanceBlobs')?['value']\",\n              \"where\": \"@less(item()?['LastModified'], subtractFromTime(utcNow(), 7, 'Day'))\"\n            },\n            \"runAfter\": {},\n            \"type\": \"Query\"\n          }\n        },\n        \"expression\": {\n          \"and\": [\n            {\n              \"greater\": [\n                \"@length(body('ListAllAssetMaintenanceBlobs')?['value'])\",\n                1\n              ]\n            }\n          ]\n        },\n        \"runAfter\": {\n          \"ListAllAssetMaintenanceBlobs\": [\n            \"Succeeded\"\n          ]\n        },\n        \"type\": \"If\"\n      },\n      \"CleanupSensorItemBatchAttributeMappingsIfMoreThanOneBlob\": {\n        \"actions\": {\n          \"FilterSensorItemBatchAttributeMappingsOlderThan7Days\": {\n            \"inputs\": {\n              \"from\": \"@body('ListAllSensorJobItembatchAttributeMappings')?['value']\",\n              \"where\": \"@less(item()?['LastModified'], subtractFromTime(utcNow(), 7, 'Day'))\"\n            },\n            \"runAfter\": {},\n            \"type\": \"Query\"\n          },\n          \"SensorJobItemBatchAttributeMappingCleanupLoop\": {\n            \"actions\": {\n              \"Delete_blob_(V2)\": {\n                \"inputs\": {\n                  \"headers\": {\n                    \"SkipDeleteIfFileNotFoundOnServer\": false\n                  },\n                  \"host\": {\n                    \"connection\": {\n                      \"name\": \"@parameters('$connections')['azureblob']['connectionId']\"\n                    }\n                  },\n                  \"method\": \"delete\",\n                  \"path\": \"/v2/datasets/@{encodeURIComponent(encodeURIComponent(parameters('StorageAccountName')))}/files/@{encodeURIComponent(encodeURIComponent(items('SensorJobItemBatchAttributeMappingCleanupLoop')?['Path']))}\"\n                },\n                \"runAfter\": {},\n                \"type\": \"ApiConnection\"\n              }\n            },\n            \"foreach\": \"@body('FilterSensorItemBatchAttributeMappingsOlderThan7Days')\",\n            \"runAfter\": {\n              \"FilterSensorItemBatchAttributeMappingsOlderThan7Days\": [\n                \"Succeeded\"\n              ]\n            },\n            \"type\": \"Foreach\"\n          }\n        },\n        \"expression\": {\n          \"and\": [\n            {\n              \"greater\": [\n                \"@length(body('ListAllSensorJobItembatchAttributeMappings')?['value'])\",\n                1\n              ]\n            }\n          ]\n        },\n        \"runAfter\": {\n          \"ListAllSensorJobItembatchAttributeMappings\": [\n            \"Succeeded\"\n          ]\n        },\n        \"type\": \"If\"\n      },\n      \"CleanupSensorJobsIfMoreThanOneBlob\": {\n        \"actions\": {\n          \"FilterSensorJobsBlobsOlderThan7Days\": {\n            \"inputs\": {\n              \"from\": \"@body('ListAllSensorJobsBlobs')?['value']\",\n              \"where\": \"@less(item()?['LastModified'], subtractFromTime(utcNow(), 7, 'Day'))\"\n            },\n            \"runAfter\": {},\n            \"type\": \"Query\"\n          },\n          \"SensorJobCleanupLoop\": {\n            \"actions\": {\n              \"DeleteOldSensorJobsBlob\": {\n                \"inputs\": {\n                  \"headers\": {\n                    \"SkipDeleteIfFileNotFoundOnServer\": false\n                  },\n                  \"host\": {\n                    \"connection\": {\n                      \"name\": \"@parameters('$connections')['azureblob']['connectionId']\"\n                    }\n                  },\n                  \"method\": \"delete\",\n                  \"path\": \"/v2/datasets/@{encodeURIComponent(encodeURIComponent(parameters('StorageAccountName')))}/files/@{encodeURIComponent(encodeURIComponent(items('SensorJobCleanupLoop')?['Path']))}\"\n                },\n                \"runAfter\": {},\n                \"type\": \"ApiConnection\"\n              }\n            },\n            \"foreach\": \"@body('FilterSensorJobsBlobsOlderThan7Days')\",\n            \"runAfter\": {\n              \"FilterSensorJobsBlobsOlderThan7Days\": [\n                \"Succeeded\"\n              ]\n            },\n            \"type\": \"Foreach\"\n          }\n        },\n        \"expression\": {\n          \"and\": [\n            {\n              \"greater\": [\n                \"@length(body('ListAllSensorJobsBlobs')?['value'])\",\n                1\n              ]\n            }\n          ]\n        },\n        \"runAfter\": {\n          \"ListAllSensorJobsBlobs\": [\n            \"Succeeded\"\n          ]\n        },\n        \"type\": \"If\"\n      },\n      \"CreateAssetMaintenanceMappingsBlob\": {\n        \"inputs\": {\n          \"body\": \"@body('ParseAssetMaintenanceRefData')?['value']\",\n          \"headers\": {\n            \"ReadFileMetadataFromServer\": true\n          },\n          \"host\": {\n            \"connection\": {\n              \"name\": \"@parameters('$connections')['azureblob']['connectionId']\"\n            }\n          },\n          \"method\": \"post\",\n          \"path\": \"/v2/datasets/@{encodeURIComponent(encodeURIComponent(parameters('StorageAccountName')))}/files\",\n          \"queries\": {\n            \"folderPath\": \"sensorintelligencereferencedata/assetmaintenancedata\",\n            \"name\": \"@{concat('assetmaintanence', utcNow('yyyy-MM-ddTHH-mm'), '.json')}\",\n            \"queryParametersSingleEncoded\": true\n          }\n        },\n        \"runAfter\": {\n          \"ParseAssetMaintenanceRefData\": [\n            \"Succeeded\"\n          ]\n        },\n        \"runtimeConfiguration\": {\n          \"contentTransfer\": {\n            \"transferMode\": \"Chunked\"\n          }\n        },\n        \"type\": \"ApiConnection\"\n      },\n      \"CreateSensorItemBatchAttributeMappingsBlob\": {\n        \"inputs\": {\n          \"body\": \"@body('ParseSensorItemBatchAttributeMappingsRefData')?['value']\",\n          \"headers\": {\n            \"ReadFileMetadataFromServer\": true\n          },\n          \"host\": {\n            \"connection\": {\n              \"name\": \"@parameters('$connections')['azureblob']['connectionId']\"\n            }\n          },\n          \"method\": \"post\",\n          \"path\": \"/v2/datasets/@{encodeURIComponent(encodeURIComponent(parameters('StorageAccountName')))}/files\",\n          \"queries\": {\n            \"folderPath\": \"sensorintelligencereferencedata/sensorjobbatchattributes\",\n            \"name\": \"@{concat('sensorjobitembatchattributemappings', utcNow('yyyy-MM-ddTHH-mm'), '.json')}\",\n            \"queryParametersSingleEncoded\": true\n          }\n        },\n        \"runAfter\": {\n          \"ParseSensorItemBatchAttributeMappingsRefData\": [\n            \"Succeeded\"\n          ]\n        },\n        \"runtimeConfiguration\": {\n          \"contentTransfer\": {\n            \"transferMode\": \"Chunked\"\n          }\n        },\n        \"type\": \"ApiConnection\"\n      },\n      \"CreateSensorJobsBlob\": {\n        \"inputs\": {\n          \"body\": \"@body('ParseSensorJobsRefData')?['value']\",\n          \"headers\": {\n            \"ReadFileMetadataFromServer\": true\n          },\n          \"host\": {\n            \"connection\": {\n              \"name\": \"@parameters('$connections')['azureblob']['connectionId']\"\n            }\n          },\n          \"method\": \"post\",\n          \"path\": \"/v2/datasets/@{encodeURIComponent(encodeURIComponent(parameters('StorageAccountName')))}/files\",\n          \"queries\": {\n            \"folderPath\": \"sensorintelligencereferencedata/sensorjobs\",\n            \"name\": \"@{concat('sensorjobs', utcNow('yyyy-MM-ddTHH-mm'), '.json')}\",\n            \"queryParametersSingleEncoded\": true\n          }\n        },\n        \"runAfter\": {\n          \"ParseSensorJobsRefData\": [\n            \"Succeeded\"\n          ]\n        },\n        \"runtimeConfiguration\": {\n          \"contentTransfer\": {\n            \"transferMode\": \"Chunked\"\n          }\n        },\n        \"type\": \"ApiConnection\"\n      },\n      \"GetAssetMaintenanceMappings\": {\n        \"inputs\": {\n          \"authentication\": \"@parameters('DynamicsIdentityAuthentication')\",\n          \"method\": \"GET\",\n          \"uri\": \"@{parameters('EnvironmentUrl')}/data/SensorScenarioMappings?@{variables('AssetMaintenanceMappingsRefDataQuery')}\"\n        },\n        \"runAfter\": {\n          \"AssetMaintenanceMappingsRefDataQuery\": [\n            \"Succeeded\"\n          ]\n        },\n        \"type\": \"Http\"\n      },\n      \"GetSensorItemBatchAttributeMappings\": {\n        \"inputs\": {\n          \"authentication\": \"@parameters('DynamicsIdentityAuthentication')\",\n          \"method\": \"GET\",\n          \"uri\": \"@{parameters('EnvironmentUrl')}/data/SensorJobItemBatchAttributes\"\n        },\n        \"runAfter\": {},\n        \"type\": \"Http\"\n      },\n      \"GetSensorJobs\": {\n        \"inputs\": {\n          \"authentication\": \"@parameters('DynamicsIdentityAuthentication')\",\n          \"method\": \"GET\",\n          \"uri\": \"@{parameters('EnvironmentUrl')}/data/SensorJobs\"\n        },\n        \"runAfter\": {},\n        \"type\": \"Http\"\n      },\n      \"ListAllAssetMaintenanceBlobs\": {\n        \"inputs\": {\n          \"host\": {\n            \"connection\": {\n              \"name\": \"@parameters('$connections')['azureblob']['connectionId']\"\n            }\n          },\n          \"method\": \"get\",\n          \"path\": \"/v2/datasets/@{encodeURIComponent(encodeURIComponent(parameters('StorageAccountName')))}/foldersV2/@{encodeURIComponent(encodeURIComponent('/sensorintelligencereferencedata/assetmaintenancedata'))}\",\n          \"queries\": {\n            \"nextPageMarker\": \"\",\n            \"useFlatListing\": false\n          }\n        },\n        \"runAfter\": {},\n        \"type\": \"ApiConnection\"\n      },\n      \"ListAllSensorJobItembatchAttributeMappings\": {\n        \"inputs\": {\n          \"host\": {\n            \"connection\": {\n              \"name\": \"@parameters('$connections')['azureblob']['connectionId']\"\n            }\n          },\n          \"method\": \"get\",\n          \"path\": \"/v2/datasets/@{encodeURIComponent(encodeURIComponent(parameters('StorageAccountName')))}/foldersV2/@{encodeURIComponent(encodeURIComponent('/sensorintelligencereferencedata/sensorjobbatchattributes'))}\",\n          \"queries\": {\n            \"nextPageMarker\": \"\",\n            \"useFlatListing\": false\n          }\n        },\n        \"runAfter\": {},\n        \"type\": \"ApiConnection\"\n      },\n      \"ListAllSensorJobsBlobs\": {\n        \"inputs\": {\n          \"host\": {\n            \"connection\": {\n              \"name\": \"@parameters('$connections')['azureblob']['connectionId']\"\n            }\n          },\n          \"method\": \"get\",\n          \"path\": \"/v2/datasets/@{encodeURIComponent(encodeURIComponent(parameters('StorageAccountName')))}/foldersV2/@{encodeURIComponent(encodeURIComponent('/sensorintelligencereferencedata/sensorjobs'))}\",\n          \"queries\": {\n            \"nextPageMarker\": \"\",\n            \"useFlatListing\": false\n          }\n        },\n        \"runAfter\": {},\n        \"type\": \"ApiConnection\"\n      },\n      \"ParseAssetMaintenanceRefData\": {\n        \"inputs\": {\n          \"content\": \"@body('GetAssetMaintenanceMappings')\",\n          \"schema\": {\n            \"properties\": {\n              \"value\": {\n                \"type\": \"array\"\n              }\n            },\n            \"type\": \"object\"\n          }\n        },\n        \"runAfter\": {\n          \"GetAssetMaintenanceMappings\": [\n            \"Succeeded\"\n          ]\n        },\n        \"type\": \"ParseJson\"\n      },\n      \"ParseSensorItemBatchAttributeMappingsRefData\": {\n        \"inputs\": {\n          \"content\": \"@body('GetSensorItemBatchAttributeMappings')\",\n          \"schema\": {\n            \"properties\": {\n              \"value\": {\n                \"type\": \"array\"\n              }\n            },\n            \"type\": \"object\"\n          }\n        },\n        \"runAfter\": {\n          \"GetSensorItemBatchAttributeMappings\": [\n            \"Succeeded\"\n          ]\n        },\n        \"type\": \"ParseJson\"\n      },\n      \"ParseSensorJobsRefData\": {\n        \"inputs\": {\n          \"content\": \"@body('GetSensorJobs')\",\n          \"schema\": {\n            \"properties\": {\n              \"value\": {\n                \"type\": \"array\"\n              }\n            },\n            \"type\": \"object\"\n          }\n        },\n        \"runAfter\": {\n          \"GetSensorJobs\": [\n            \"Succeeded\"\n          ]\n        },\n        \"type\": \"ParseJson\"\n      }\n    },\n    \"contentVersion\": \"1.0.0.0\",\n    \"outputs\": {},\n    \"parameters\": {\n      \"$connections\": {\n        \"defaultValue\": {},\n        \"type\": \"Object\"\n      },\n      \"DynamicsIdentityAuthentication\": {\n        \"defaultValue\": {},\n        \"type\": \"Object\"\n      },\n      \"EnvironmentUrl\": {\n        \"defaultValue\": \"\",\n        \"type\": \"String\"\n      },\n      \"StorageAccountName\": {\n        \"defaultValue\": \"\",\n        \"type\": \"String\"\n      }\n    },\n    \"triggers\": {\n      \"Recurrence\": {\n        \"evaluatedRecurrence\": {\n          \"frequency\": \"Minute\",\n          \"interval\": 3\n        },\n        \"recurrence\": {\n          \"frequency\": \"Minute\",\n          \"interval\": 3\n        },\n        \"type\": \"Recurrence\"\n      }\n    }\n  },\n  \"parameters\": {}\n}\n",
    "$fxv#4": "{\n  \"definition\": {\n    \"$schema\": \"https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#\",\n    \"actions\": {\n      \"Complete_Insight_message_in_queue\": {\n        \"inputs\": {\n          \"host\": {\n            \"connection\": {\n              \"name\": \"@parameters('$connections')['servicebus']['connectionId']\"\n            }\n          },\n          \"method\": \"delete\",\n          \"path\": \"/@{encodeURIComponent(encodeURIComponent('outbound-insights'))}/messages/complete\",\n          \"queries\": {\n            \"lockToken\": \"@triggerBody()?['LockToken']\",\n            \"queueType\": \"Main\",\n            \"sessionId\": \"\"\n          }\n        },\n        \"runAfter\": {\n          \"Post_Notification\": [\n            \"Succeeded\"\n          ]\n        },\n        \"type\": \"ApiConnection\"\n      },\n      \"Compose_Notification_object\": {\n        \"inputs\": {\n          \"Id\": \"@{variables('NotificationGUID')}\",\n          \"NotificationRaisedDateTime\": \"@{body('Parse_Insight')?['timestamp']}\",\n          \"Payload\": \"@decodeBase64(triggerBody()?['ContentData'])\",\n          \"Type\": \"@{body('Parse_Insight')?['notificationType']}\"\n        },\n        \"runAfter\": {\n          \"Notification_GUID\": [\n            \"Succeeded\"\n          ]\n        },\n        \"type\": \"Compose\"\n      },\n      \"Notification_GUID\": {\n        \"inputs\": {\n          \"variables\": [\n            {\n              \"name\": \"NotificationGUID\",\n              \"type\": \"string\",\n              \"value\": \"@triggerBody()?['LockToken']\"\n            }\n          ]\n        },\n        \"runAfter\": {\n          \"Parse_Insight\": [\n            \"Succeeded\"\n          ]\n        },\n        \"type\": \"InitializeVariable\"\n      },\n      \"Parse_Insight\": {\n        \"inputs\": {\n          \"content\": \"@decodeBase64(triggerBody()?['ContentData'])\",\n          \"schema\": {\n            \"properties\": {\n              \"notificationType\": {\n                \"type\": \"string\"\n              },\n              \"timestamp\": {\n                \"type\": \"string\"\n              }\n            },\n            \"type\": \"object\"\n          }\n        },\n        \"runAfter\": {},\n        \"type\": \"ParseJson\"\n      },\n      \"Post_Notification\": {\n        \"inputs\": {\n          \"authentication\": \"@parameters('DynamicsIdentityAuthentication')\",\n          \"body\": \"@outputs('Compose_Notification_object')\",\n          \"headers\": {\n            \"Content-Type\": \"application/json\"\n          },\n          \"method\": \"POST\",\n          \"uri\": \"@{parameters('EnvironmentUrl')}/data/OperationsNotifications\"\n        },\n        \"runAfter\": {\n          \"Compose_Notification_object\": [\n            \"Succeeded\"\n          ]\n        },\n        \"type\": \"Http\"\n      }\n    },\n    \"contentVersion\": \"1.0.0.0\",\n    \"parameters\": {\n      \"$connections\": {\n        \"defaultValue\": {},\n        \"type\": \"Object\"\n      },\n      \"DynamicsIdentityAuthentication\": {\n        \"defaultValue\": {},\n        \"type\": \"Object\"\n      },\n      \"EnvironmentUrl\": {\n        \"defaultValue\": \"\",\n        \"type\": \"String\"\n      }\n    },\n    \"triggers\": {\n      \"When_Insight_is_added_to_outbound_queue_(peek-lock)\": {\n        \"evaluatedRecurrence\": {\n          \"frequency\": \"Second\",\n          \"interval\": 30\n        },\n        \"inputs\": {\n          \"host\": {\n            \"connection\": {\n              \"name\": \"@parameters('$connections')['servicebus']['connectionId']\"\n            }\n          },\n          \"method\": \"get\",\n          \"path\": \"/@{encodeURIComponent(encodeURIComponent('outbound-insights'))}/messages/head/peek\",\n          \"queries\": {\n            \"queryType\": \"Main\"\n          }\n        },\n        \"recurrence\": {\n          \"frequency\": \"Second\",\n          \"interval\": 30\n        },\n        \"type\": \"ApiConnection\"\n      }\n    }\n  },\n  \"parameters\": {}\n}\n",
    "resourcesLocation": "[resourceGroup().location]",
    "uniqueIdentifier": "[uniqueString(resourceGroup().id)]",
    "createNewIotHub": "[empty(parameters('existingIotHubName'))]",
    "azureServiceBusDataReceiverRoleId": "4f6d3b9b-027b-4f4c-9142-0e5a2a2247e0",
    "azureStorageBlobDataContributorRoleId": "ba92f5b4-2d11-453d-a403-e96b0029c9fe",
    "trimmedEnvironmentUrl": "[trim(parameters('environmentUrl'))]",
    "streamScenarioJobs": [
      {
        "scenario": "machine-reporting-status",
        "referenceDataName": "SensorJobsReferenceInput",
        "referencePathPattern": "sensorjobs/sensorjobs{date}T{time}.json",
        "query": "[variables('$fxv#0')]"
      },
      {
        "scenario": "asset-maintenance",
        "referenceDataName": "ScenarioMappings",
        "referencePathPattern": "assetmaintenancedata/assetmaintanence{date}T{time}.json",
        "query": "[variables('$fxv#1')]"
      },
      {
        "scenario": "product-quality-validation",
        "referenceDataName": "SensorJobItemBatchAttributeReferenceInput",
        "referencePathPattern": "sensorjobbatchattributes/sensorjobitembatchattributemappings{date}T{time}.json",
        "query": "[variables('$fxv#2')]"
      }
    ]
  },
  "resources": [
    {
      "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
      "apiVersion": "2021-08-01",
      "name": "[format('{0}/{1}/{2}', format('msdyniiotst{0}', variables('uniqueIdentifier')), 'default', 'iotoutputstoragev2')]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts/blobServices', format('msdyniiotst{0}', variables('uniqueIdentifier')), 'default')]"
      ]
    },
    {
      "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
      "apiVersion": "2021-08-01",
      "name": "[format('{0}/{1}/{2}', format('msdyniiotst{0}', variables('uniqueIdentifier')), 'default', 'sensorintelligencereferencedata')]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts/blobServices', format('msdyniiotst{0}', variables('uniqueIdentifier')), 'default')]"
      ]
    },
    {
      "type": "Microsoft.Storage/storageAccounts/blobServices",
      "apiVersion": "2021-08-01",
      "name": "[format('{0}/{1}', format('msdyniiotst{0}', variables('uniqueIdentifier')), 'default')]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', format('msdyniiotst{0}', variables('uniqueIdentifier')))]"
      ]
    },
    {
      "type": "Microsoft.ServiceBus/namespaces/queues/authorizationRules",
      "apiVersion": "2021-06-01-preview",
      "name": "[format('{0}/{1}/{2}', format('msdyn-iiot-sdi-servicebus-{0}', variables('uniqueIdentifier')), 'outbound-insights', 'AsaSendRule')]",
      "properties": {
        "rights": [
          "Send"
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.ServiceBus/namespaces/queues', format('msdyn-iiot-sdi-servicebus-{0}', variables('uniqueIdentifier')), 'outbound-insights')]"
      ]
    },
    {
      "type": "Microsoft.ServiceBus/namespaces/queues",
      "apiVersion": "2021-06-01-preview",
      "name": "[format('{0}/{1}', format('msdyn-iiot-sdi-servicebus-{0}', variables('uniqueIdentifier')), 'outbound-insights')]",
      "properties": {
        "enablePartitioning": false,
        "enableBatchedOperations": true
      },
      "dependsOn": [
        "[resourceId('Microsoft.ServiceBus/namespaces', format('msdyn-iiot-sdi-servicebus-{0}', variables('uniqueIdentifier')))]"
      ]
    },
    {
      "type": "Microsoft.Web/sites/sourcecontrols",
      "apiVersion": "2021-03-01",
      "name": "[format('{0}/{1}', format('msdyn-iiot-sdi-functionapp-{0}', variables('uniqueIdentifier')), 'web')]",
      "kind": "gitHubHostedTemplate",
      "properties": {
        "repoUrl": "https://github.com/AndreasHassing/AzureStreamAnalyticsToRedisFunction",
        "branch": "main",
        "isManualIntegration": true
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deploymentScripts', 'appDeploymentWait')]",
        "[resourceId('Microsoft.Web/sites', format('msdyn-iiot-sdi-functionapp-{0}', variables('uniqueIdentifier')))]"
      ]
    },
    {
      "type": "Microsoft.Cache/redis",
      "apiVersion": "2021-06-01",
      "name": "[format('msdyn-iiot-sdi-redis-{0}', variables('uniqueIdentifier'))]",
      "location": "[variables('resourcesLocation')]",
      "properties": {
        "redisVersion": "4.1.14",
        "sku": {
          "name": "Basic",
          "family": "C",
          "capacity": 0
        }
      }
    },
    {
      "condition": "[variables('createNewIotHub')]",
      "type": "Microsoft.Devices/IotHubs",
      "apiVersion": "2021-07-02",
      "name": "[format('msdyn-iiot-sdi-iothub-{0}', variables('uniqueIdentifier'))]",
      "location": "[variables('resourcesLocation')]",
      "sku": {
        "name": "B1",
        "capacity": 1
      },
      "properties": {}
    },
    {
      "copy": {
        "name": "iotHubConsumerGroups",
        "count": "[length(variables('streamScenarioJobs'))]"
      },
      "type": "Microsoft.Devices/IotHubs/eventHubEndpoints/ConsumerGroups",
      "apiVersion": "2021-07-02",
      "name": "[format('{0}/events/{1}', if(variables('createNewIotHub'), format('msdyn-iiot-sdi-iothub-{0}', variables('uniqueIdentifier')), parameters('existingIotHubName')), variables('streamScenarioJobs')[copyIndex()].scenario)]",
      "properties": {
        "name": "[variables('streamScenarioJobs')[copyIndex()].scenario]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Devices/IotHubs', format('msdyn-iiot-sdi-iothub-{0}', variables('uniqueIdentifier')))]"
      ]
    },
    {
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2021-08-01",
      "name": "[format('msdyniiotst{0}', variables('uniqueIdentifier'))]",
      "location": "[variables('resourcesLocation')]",
      "sku": {
        "name": "Standard_LRS"
      },
      "kind": "StorageV2",
      "properties": {
        "accessTier": "Hot",
        "minimumTlsVersion": "TLS1_2",
        "supportsHttpsTrafficOnly": true,
        "allowBlobPublicAccess": false
      }
    },
    {
      "type": "Microsoft.ServiceBus/namespaces",
      "apiVersion": "2021-06-01-preview",
      "name": "[format('msdyn-iiot-sdi-servicebus-{0}', variables('uniqueIdentifier'))]",
      "location": "[variables('resourcesLocation')]",
      "sku": {
        "name": "Basic",
        "tier": "Basic"
      }
    },
    {
      "type": "Microsoft.Web/serverfarms",
      "apiVersion": "2021-03-01",
      "name": "[format('msdyn-iiot-sdi-appsvcplan-{0}', variables('uniqueIdentifier'))]",
      "location": "[variables('resourcesLocation')]",
      "sku": {
        "name": "F1",
        "capacity": 0
      }
    },
    {
      "type": "Microsoft.Web/sites",
      "apiVersion": "2021-03-01",
      "name": "[format('msdyn-iiot-sdi-functionapp-{0}', variables('uniqueIdentifier'))]",
      "location": "[variables('resourcesLocation')]",
      "kind": "functionapp",
      "properties": {
        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', format('msdyn-iiot-sdi-appsvcplan-{0}', variables('uniqueIdentifier')))]",
        "httpsOnly": true,
        "siteConfig": {
          "minTlsVersion": "1.2",
          "ftpsState": "Disabled",
          "appSettings": [
            {
              "name": "AzureWebJobsStorage",
              "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};EndpointSuffix={1};AccountKey={2}', format('msdyniiotst{0}', variables('uniqueIdentifier')), environment().suffixes.storage, listKeys(resourceId('Microsoft.Storage/storageAccounts', format('msdyniiotst{0}', variables('uniqueIdentifier'))), '2021-08-01').keys[0].value)]"
            },
            {
              "name": "FUNCTIONS_EXTENSION_VERSION",
              "value": "~4"
            },
            {
              "name": "FUNCTIONS_WORKER_RUNTIME",
              "value": "dotnet"
            },
            {
              "name": "RedisConnectionString",
              "value": "[format('{0}:{1},password={2},ssl=True,abortConnect=False', reference(resourceId('Microsoft.Cache/redis', format('msdyn-iiot-sdi-redis-{0}', variables('uniqueIdentifier')))).hostName, reference(resourceId('Microsoft.Cache/redis', format('msdyn-iiot-sdi-redis-{0}', variables('uniqueIdentifier')))).sslPort, listKeys(resourceId('Microsoft.Cache/redis', format('msdyn-iiot-sdi-redis-{0}', variables('uniqueIdentifier'))), '2021-06-01').primaryKey)]"
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Web/serverfarms', format('msdyn-iiot-sdi-appsvcplan-{0}', variables('uniqueIdentifier')))]",
        "[resourceId('Microsoft.Cache/redis', format('msdyn-iiot-sdi-redis-{0}', variables('uniqueIdentifier')))]",
        "[resourceId('Microsoft.Storage/storageAccounts', format('msdyniiotst{0}', variables('uniqueIdentifier')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deploymentScripts",
      "apiVersion": "2020-10-01",
      "name": "appDeploymentWait",
      "location": "[variables('resourcesLocation')]",
      "kind": "AzurePowerShell",
      "properties": {
        "retentionInterval": "PT1H",
        "azPowerShellVersion": "7.3.2",
        "scriptContent": "Start-Sleep -Seconds 30"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Web/sites', format('msdyn-iiot-sdi-functionapp-{0}', variables('uniqueIdentifier')))]"
      ]
    },
    {
      "copy": {
        "name": "streamAnalyticsJobs",
        "count": "[length(variables('streamScenarioJobs'))]"
      },
      "type": "Microsoft.StreamAnalytics/streamingjobs",
      "apiVersion": "2021-10-01-preview",
      "name": "[format('msdyn-iiot-sdi-{0}-{1}', variables('streamScenarioJobs')[copyIndex()].scenario, variables('uniqueIdentifier'))]",
      "location": "[variables('resourcesLocation')]",
      "identity": {
        "type": "SystemAssigned"
      },
      "properties": {
        "sku": {
          "name": "Standard"
        },
        "compatibilityLevel": "1.2",
        "outputStartMode": "JobStartTime",
        "inputs": [
          {
            "name": "IotInput",
            "properties": {
              "type": "Stream",
              "datasource": {
                "type": "Microsoft.Devices/IotHubs",
                "properties": {
                  "iotHubNamespace": "[if(variables('createNewIotHub'), format('msdyn-iiot-sdi-iothub-{0}', variables('uniqueIdentifier')), parameters('existingIotHubName'))]",
                  "sharedAccessPolicyName": "[if(variables('createNewIotHub'), listkeys(resourceId('Microsoft.Devices/IotHubs', format('msdyn-iiot-sdi-iothub-{0}', variables('uniqueIdentifier'))), '2021-07-02').value[1].keyName, listkeys(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('existingIotHubResourceGroupName')), 'Microsoft.Devices/IotHubs', parameters('existingIotHubName')), '2021-07-02').value[1].keyName)]",
                  "sharedAccessPolicyKey": "[if(variables('createNewIotHub'), listkeys(resourceId('Microsoft.Devices/IotHubs', format('msdyn-iiot-sdi-iothub-{0}', variables('uniqueIdentifier'))), '2021-07-02').value[1].primaryKey, listkeys(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('existingIotHubResourceGroupName')), 'Microsoft.Devices/IotHubs', parameters('existingIotHubName')), '2021-07-02').value[1].primaryKey)]",
                  "endpoint": "messages/events",
                  "consumerGroupName": "[variables('streamScenarioJobs')[copyIndex()].scenario]"
                }
              },
              "serialization": {
                "type": "Json",
                "properties": {
                  "encoding": "UTF8"
                }
              }
            }
          },
          {
            "name": "[variables('streamScenarioJobs')[copyIndex()].referenceDataName]",
            "properties": {
              "type": "Reference",
              "datasource": {
                "type": "Microsoft.Storage/Blob",
                "properties": {
                  "authenticationMode": "Msi",
                  "storageAccounts": [
                    {
                      "accountName": "[format('msdyniiotst{0}', variables('uniqueIdentifier'))]"
                    }
                  ],
                  "container": "sensorintelligencereferencedata",
                  "pathPattern": "[variables('streamScenarioJobs')[copyIndex()].referencePathPattern]",
                  "dateFormat": "yyyy-MM-dd",
                  "timeFormat": "HH-mm"
                }
              },
              "serialization": {
                "type": "Json",
                "properties": {
                  "encoding": "UTF8"
                }
              }
            }
          }
        ],
        "outputs": [
          {
            "name": "MetricOutput",
            "properties": {
              "datasource": {
                "type": "Microsoft.AzureFunction",
                "properties": {
                  "functionAppName": "[format('msdyn-iiot-sdi-functionapp-{0}', variables('uniqueIdentifier'))]",
                  "functionName": "AzureStreamAnalyticsToRedis",
                  "apiKey": "[listKeys(format('{0}/host/default', resourceId('Microsoft.Web/sites', format('msdyn-iiot-sdi-functionapp-{0}', variables('uniqueIdentifier')))), '2021-02-01').functionKeys.default]"
                }
              }
            }
          },
          {
            "name": "NotificationOutput",
            "properties": {
              "datasource": {
                "type": "Microsoft.ServiceBus/Queue",
                "properties": {
                  "serviceBusNamespace": "[format('msdyn-iiot-sdi-servicebus-{0}', variables('uniqueIdentifier'))]",
                  "queueName": "outbound-insights",
                  "authenticationMode": "ConnectionString",
                  "sharedAccessPolicyName": "[listKeys(resourceId('Microsoft.ServiceBus/namespaces/queues/authorizationRules', format('msdyn-iiot-sdi-servicebus-{0}', variables('uniqueIdentifier')), 'outbound-insights', 'AsaSendRule'), '2021-06-01-preview').keyName]",
                  "sharedAccessPolicyKey": "[listKeys(resourceId('Microsoft.ServiceBus/namespaces/queues/authorizationRules', format('msdyn-iiot-sdi-servicebus-{0}', variables('uniqueIdentifier')), 'outbound-insights', 'AsaSendRule'), '2021-06-01-preview').primaryKey]"
                }
              },
              "serialization": {
                "type": "Json",
                "properties": {
                  "encoding": "UTF8",
                  "format": "Array"
                }
              }
            }
          }
        ],
        "transformation": {
          "name": "input2output",
          "properties": {
            "query": "[variables('streamScenarioJobs')[copyIndex()].query]"
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.ServiceBus/namespaces/queues/authorizationRules', format('msdyn-iiot-sdi-servicebus-{0}', variables('uniqueIdentifier')), 'outbound-insights', 'AsaSendRule')]",
        "[resourceId('Microsoft.ServiceBus/namespaces', format('msdyn-iiot-sdi-servicebus-{0}', variables('uniqueIdentifier')))]",
        "[resourceId('Microsoft.Web/sites', format('msdyn-iiot-sdi-functionapp-{0}', variables('uniqueIdentifier')))]",
        "[resourceId('Microsoft.Web/sites/sourcecontrols', format('msdyn-iiot-sdi-functionapp-{0}', variables('uniqueIdentifier')), 'web')]",
        "[resourceId('Microsoft.Devices/IotHubs', format('msdyn-iiot-sdi-iothub-{0}', variables('uniqueIdentifier')))]",
        "[resourceId('Microsoft.ServiceBus/namespaces/queues', format('msdyn-iiot-sdi-servicebus-{0}', variables('uniqueIdentifier')), 'outbound-insights')]",
        "[resourceId('Microsoft.Storage/storageAccounts/blobServices/containers', format('msdyniiotst{0}', variables('uniqueIdentifier')), 'default', 'sensorintelligencereferencedata')]",
        "[resourceId('Microsoft.Storage/storageAccounts', format('msdyniiotst{0}', variables('uniqueIdentifier')))]"
      ]
    },
    {
      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
      "apiVersion": "2018-11-30",
      "name": "[format('msdyn-iiot-sdi-identity-{0}', variables('uniqueIdentifier'))]",
      "location": "[variables('resourcesLocation')]"
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2020-10-01-preview",
      "scope": "[format('Microsoft.ServiceBus/namespaces/{0}', format('msdyn-iiot-sdi-servicebus-{0}', variables('uniqueIdentifier')))]",
      "name": "[guid(resourceId('Microsoft.ServiceBus/namespaces/queues', format('msdyn-iiot-sdi-servicebus-{0}', variables('uniqueIdentifier')), 'outbound-insights'), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('msdyn-iiot-sdi-identity-{0}', variables('uniqueIdentifier'))), variables('azureServiceBusDataReceiverRoleId'))]",
      "properties": {
        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('azureServiceBusDataReceiverRoleId'))]",
        "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('msdyn-iiot-sdi-identity-{0}', variables('uniqueIdentifier')))).principalId]",
        "principalType": "ServicePrincipal",
        "description": "[format('For letting {0} read from Service Bus queues.', format('msdyn-iiot-sdi-identity-{0}', variables('uniqueIdentifier')))]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.ServiceBus/namespaces', format('msdyn-iiot-sdi-servicebus-{0}', variables('uniqueIdentifier')))]",
        "[resourceId('Microsoft.ServiceBus/namespaces/queues', format('msdyn-iiot-sdi-servicebus-{0}', variables('uniqueIdentifier')), 'outbound-insights')]",
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('msdyn-iiot-sdi-identity-{0}', variables('uniqueIdentifier')))]"
      ]
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2020-10-01-preview",
      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', format('msdyniiotst{0}', variables('uniqueIdentifier')))]",
      "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', format('msdyniiotst{0}', variables('uniqueIdentifier'))), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('msdyn-iiot-sdi-identity-{0}', variables('uniqueIdentifier'))), variables('azureStorageBlobDataContributorRoleId'))]",
      "properties": {
        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('azureStorageBlobDataContributorRoleId'))]",
        "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('msdyn-iiot-sdi-identity-{0}', variables('uniqueIdentifier')))).principalId]",
        "principalType": "ServicePrincipal",
        "description": "[format('For letting {0} insert blobs into the reference data Storage Account.', format('msdyn-iiot-sdi-identity-{0}', variables('uniqueIdentifier')))]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('msdyn-iiot-sdi-identity-{0}', variables('uniqueIdentifier')))]",
        "[resourceId('Microsoft.Storage/storageAccounts', format('msdyniiotst{0}', variables('uniqueIdentifier')))]"
      ]
    },
    {
      "copy": {
        "name": "streamAnalyticsBlobDataContributorRoleAssignment",
        "count": "[length(range(0, length(variables('streamScenarioJobs'))))]"
      },
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2020-10-01-preview",
      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', format('msdyniiotst{0}', variables('uniqueIdentifier')))]",
      "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', format('msdyniiotst{0}', variables('uniqueIdentifier'))), resourceId('Microsoft.StreamAnalytics/streamingjobs', format('msdyn-iiot-sdi-{0}-{1}', variables('streamScenarioJobs')[range(0, length(variables('streamScenarioJobs')))[copyIndex()]].scenario, variables('uniqueIdentifier'))), variables('azureStorageBlobDataContributorRoleId'))]",
      "properties": {
        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('azureStorageBlobDataContributorRoleId'))]",
        "principalId": "[reference(resourceId('Microsoft.StreamAnalytics/streamingjobs', format('msdyn-iiot-sdi-{0}-{1}', variables('streamScenarioJobs')[range(0, length(variables('streamScenarioJobs')))[copyIndex()]].scenario, variables('uniqueIdentifier'))), '2021-10-01-preview', 'full').identity.principalId]",
        "principalType": "ServicePrincipal",
        "description": "[format('For letting {0} read from the reference data Storage Account. Stream Analytics needs Contributor role to function, even if it only reads.', format('msdyn-iiot-sdi-{0}-{1}', variables('streamScenarioJobs')[range(0, length(variables('streamScenarioJobs')))[copyIndex()]].scenario, variables('uniqueIdentifier')))]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', format('msdyniiotst{0}', variables('uniqueIdentifier')))]",
        "[resourceId('Microsoft.StreamAnalytics/streamingjobs', format('msdyn-iiot-sdi-{0}-{1}', variables('streamScenarioJobs')[range(0, length(variables('streamScenarioJobs')))[copyIndex()]].scenario, variables('uniqueIdentifier')))]",
        "[resourceId('Microsoft.StreamAnalytics/streamingjobs', format('msdyn-iiot-sdi-{0}-{1}', variables('streamScenarioJobs')[range(0, length(variables('streamScenarioJobs')))[copyIndex()]].scenario, variables('uniqueIdentifier')))]",
        "[resourceId('Microsoft.StreamAnalytics/streamingjobs', format('msdyn-iiot-sdi-{0}-{1}', variables('streamScenarioJobs')[range(0, length(variables('streamScenarioJobs')))[copyIndex()]].scenario, variables('uniqueIdentifier')))]"
      ]
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2016-06-01",
      "name": "[format('msdyn-iiot-sdi-servicebusconnection-{0}', variables('uniqueIdentifier'))]",
      "location": "[variables('resourcesLocation')]",
      "properties": {
        "displayName": "[format('msdyn-iiot-sdi-servicebusconnection-{0}', variables('uniqueIdentifier'))]",
        "parameterValueSet": {
          "name": "managedIdentityAuth",
          "values": {
            "namespaceEndpoint": {
              "value": "[replace(replace(reference(resourceId('Microsoft.ServiceBus/namespaces', format('msdyn-iiot-sdi-servicebus-{0}', variables('uniqueIdentifier')))).serviceBusEndpoint, 'https://', 'sb://'), ':443', '')]"
            }
          }
        },
        "api": {
          "id": "[subscriptionResourceId('Microsoft.Web/locations/managedApis', variables('resourcesLocation'), 'servicebus')]",
          "type": "Microsoft.Web/locations/managedApis"
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.ServiceBus/namespaces', format('msdyn-iiot-sdi-servicebus-{0}', variables('uniqueIdentifier')))]"
      ]
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2016-06-01",
      "name": "[format('msdyn-iiot-sdi-storageaccountconnection-{0}', variables('uniqueIdentifier'))]",
      "location": "[variables('resourcesLocation')]",
      "properties": {
        "displayName": "[format('msdyn-iiot-sdi-storageaccountbusconnection-{0}', variables('uniqueIdentifier'))]",
        "parameterValueSet": {
          "name": "managedIdentityAuth",
          "values": {}
        },
        "api": {
          "id": "[subscriptionResourceId('Microsoft.Web/locations/managedApis', variables('resourcesLocation'), 'azureblob')]",
          "type": "Microsoft.Web/locations/managedApis"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2019-05-01",
      "name": "[format('msdyn-iiot-sdi-logicapp-refdata-{0}', variables('uniqueIdentifier'))]",
      "location": "[variables('resourcesLocation')]",
      "identity": {
        "type": "UserAssigned",
        "userAssignedIdentities": {
          "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('msdyn-iiot-sdi-identity-{0}', variables('uniqueIdentifier'))))]": {}
        }
      },
      "properties": {
        "definition": "[json(variables('$fxv#3')).definition]",
        "parameters": {
          "$connections": {
            "value": {
              "azureblob": {
                "id": "[subscriptionResourceId('Microsoft.Web/locations/managedApis', variables('resourcesLocation'), 'azureblob')]",
                "connectionId": "[resourceId('Microsoft.Web/connections', format('msdyn-iiot-sdi-storageaccountconnection-{0}', variables('uniqueIdentifier')))]",
                "connectionName": "azureblob",
                "connectionProperties": {
                  "authentication": {
                    "identity": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('msdyn-iiot-sdi-identity-{0}', variables('uniqueIdentifier')))]",
                    "type": "ManagedServiceIdentity"
                  }
                }
              }
            }
          },
          "DynamicsIdentityAuthentication": {
            "value": {
              "audience": "00000015-0000-0000-c000-000000000000",
              "identity": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('msdyn-iiot-sdi-identity-{0}', variables('uniqueIdentifier')))]",
              "type": "ManagedServiceIdentity"
            }
          },
          "EnvironmentUrl": {
            "value": "[variables('trimmedEnvironmentUrl')]"
          },
          "StorageAccountName": {
            "value": "[format('msdyniiotst{0}', variables('uniqueIdentifier'))]"
          }
        },
        "accessControl": {
          "contents": {
            "allowedCallerIpAddresses": [
              {
                "addressRange": "0.0.0.0-0.0.0.0"
              }
            ]
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Web/connections', format('msdyn-iiot-sdi-storageaccountconnection-{0}', variables('uniqueIdentifier')))]",
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('msdyn-iiot-sdi-identity-{0}', variables('uniqueIdentifier')))]",
        "[resourceId('Microsoft.Storage/storageAccounts', format('msdyniiotst{0}', variables('uniqueIdentifier')))]"
      ]
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2019-05-01",
      "name": "[format('msdyn-iiot-sdi-logicapp-notification-{0}', variables('uniqueIdentifier'))]",
      "location": "[variables('resourcesLocation')]",
      "identity": {
        "type": "UserAssigned",
        "userAssignedIdentities": {
          "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('msdyn-iiot-sdi-identity-{0}', variables('uniqueIdentifier'))))]": {}
        }
      },
      "properties": {
        "definition": "[json(variables('$fxv#4')).definition]",
        "parameters": {
          "$connections": {
            "value": {
              "servicebus": {
                "id": "[subscriptionResourceId('Microsoft.Web/locations/managedApis', variables('resourcesLocation'), 'servicebus')]",
                "connectionId": "[resourceId('Microsoft.Web/connections', format('msdyn-iiot-sdi-servicebusconnection-{0}', variables('uniqueIdentifier')))]",
                "connectionName": "servicebus",
                "connectionProperties": {
                  "authentication": {
                    "type": "ManagedServiceIdentity",
                    "identity": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('msdyn-iiot-sdi-identity-{0}', variables('uniqueIdentifier')))]"
                  }
                }
              }
            }
          },
          "DynamicsIdentityAuthentication": {
            "value": {
              "audience": "00000015-0000-0000-c000-000000000000",
              "identity": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('msdyn-iiot-sdi-identity-{0}', variables('uniqueIdentifier')))]",
              "type": "ManagedServiceIdentity"
            }
          },
          "EnvironmentUrl": {
            "value": "[variables('trimmedEnvironmentUrl')]"
          }
        },
        "accessControl": {
          "contents": {
            "allowedCallerIpAddresses": [
              {
                "addressRange": "0.0.0.0-0.0.0.0"
              }
            ]
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Web/connections', format('msdyn-iiot-sdi-servicebusconnection-{0}', variables('uniqueIdentifier')))]",
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('msdyn-iiot-sdi-identity-{0}', variables('uniqueIdentifier')))]"
      ]
    }
  ],
  "outputs": {
    "applicationId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('msdyn-iiot-sdi-identity-{0}', variables('uniqueIdentifier')))).clientId]",
      "metadata": {
        "description": "AAD Application ID to allowlist in Dynamics"
      }
    }
  }
}